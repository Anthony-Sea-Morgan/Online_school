{% extends 'index.html' %}
{% load static %}
{% block title %}
{{ title }}
{% endblock %}
{% block style %}
<link rel="stylesheet" href="{% static 'dist/scss/chat.css'%}">
<link rel="stylesheet" href="{% static 'dist/scss/wrapper-blank.css'%}">
{% endblock %}
{% block header %}
{% include "header.html" %}
{% endblock %}



{% block content %}
<div class="container">
    {% if lesson %}
    <div class="info">
        <h1>{{ lesson.title }}</h1>

        <ul>
            <li>{{ lesson.course_owner.title }}</li>
            <li>{{ lesson.start_date }}</li>
            <li>{{ lesson.start_time }}</li>
            <pre class="summernote-content">{{ lesson.material|safe }}</pre>
        </ul>
    </div>
    {% endif %}
</div>

<div class="chat" id="lobby-chat" style="display:none;">
    <div class="close-btn" id="chat-close-btn">‚®Ø</div>
        <h2 class="chat-header">–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
        <div id="chat-log"></div>
        <div id="chat-input-container">
            <textarea id="chat-input" rows="3"></textarea>
            <button id="chat-message-submit" class="chat-message-submit"></button>
        </div>
    </div>

<div class="chat" id="lobby-participants" style="display:none;">
<div class="close-btn" id="participants-close-btn">‚®Ø</div>
        <h3 class="chat-header">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–∞–Ω—è—Ç–∏—è:</h3>

        <div  class="chat-log" style="overflow-y: scroll;overflow-x: hidden; max-height: 200px;">
            <table class="form-group">
                  <tr><td>Email:</td></tr>
    {% for user in group.users.all %}
    <tr class="user-row">
        <td>
        <span class="future-lesson">
          {{ user.email }}
        </span>
      </td>
  </tr>
    {% empty %}
      <tr class="user-row"> <td>–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</td>  </tr>
    {% endfor %}


</table>
</div>

  <!-- –§–æ—Ä–º–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
<form method="POST" action="{% url 'management:remove_participant' pk=group.course_owner_id %}">
  {% csrf_token %}
  <div class="form-group">
    <label for="participant-email">Email —É—á–∞—Å—Ç–Ω–∏–∫–∞:</label>
    <input type="email" id="participant-email" name="participant_email" required>
  </div>
  <button type="submit" class="btn">–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
</form>

  <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
<form method="POST" action="{% url 'management:add_participant' pk=group.course_owner.id %}">
  {% csrf_token %}
  <div class="form-group">
    <label for="participant-email">Email —É—á–∞—Å—Ç–Ω–∏–∫–∞:</label>
    <input type="email" id="participant-email" name="participant_email" required>
  </div>
  <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
</form>
</div>
<button id="show-chat" class="side-btns">üí¨</button>
<!--<div id="show-participants" class="side-btns"><button>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏</button></div>-->
{% endblock %}

{% block script %}
<script type="text/javascript">
    const roomName = '{{ room_name }}';
    const user = '{{ user }}';

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ç—ë–º–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
    function getRandomDarkColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const userColors = {};

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const author = data.author; // –ü–æ–ª—É—á–∞–µ–º –∞–≤—Ç–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö

        // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞ userColors –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ü–≤–µ—Ç
        let userColor = userColors[author];
        if (!userColor) {
            userColor = getRandomDarkColor();
            userColors[author] = userColor;
        }

        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const timestamp = hours + ':' + minutes;
        const messageWithTimestamp = '<div style="background-color: ' + userColor + '24; color: #000; padding: 1px 10px 1px 10px; border-radius: 8px; margin-bottom: 10px;filter: brightness(70%);">' +
            '<pre style="text-wrap: balance;"><strong style="color: ' + userColor + ';">' + author + '</strong>: ' + message + '</pre>' +
            '<p style="font-size: 12px; color: #888;">' + timestamp + '</p>' +
            '</div>';
        const chatLog = document.querySelector('#chat-log');
        chatLog.innerHTML += messageWithTimestamp;
        chatLog.scrollTop = chatLog.scrollHeight; // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
    };

    document.querySelector('#chat-input').addEventListener('keyup', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            const messageInputDom = document.querySelector('#chat-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message,
                'author': user  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è –∞–≤—Ç–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            }));
            messageInputDom.value = '';
        }
    });

    document.querySelector('#chat-message-submit').addEventListener('click', function(e) {
        const messageInputDom = document.querySelector('#chat-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'author': user  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è –∞–≤—Ç–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        }));
        messageInputDom.value = '';
    });
makeLayer('lobby-chat','block', 'show-chat', 'chat-close-btn')
</script>
{% endblock %}